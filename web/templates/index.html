<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å†™æ•°å­—è¯†åˆ« - PyTorch CNN</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ§ </span>
                <h1>æ‰‹å†™æ•°å­—è¯†åˆ«</h1>
            </div>
            <p class="subtitle">åŸºäº PyTorch CNN çš„ MNIST æ•°å­—è¯†åˆ«ç³»ç»Ÿ</p>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- ç”»å¸ƒåŒºåŸŸ -->
            <section class="canvas-section">
                <h2>âœï¸ åœ¨ä¸‹æ–¹ç”»å¸ƒä¸­ä¹¦å†™æ•°å­—</h2>
                <div class="canvas-wrapper">
                    <canvas id="drawCanvas" width="280" height="280"></canvas>
                    <div class="canvas-overlay" id="canvasOverlay">
                        <span>æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ•°å­—</span>
                    </div>
                </div>
                <div class="button-group">
                    <button id="clearBtn" class="btn btn-secondary">
                        <span>ğŸ—‘ï¸</span> æ¸…é™¤
                    </button>
                    <button id="predictBtn" class="btn btn-primary">
                        <span>ğŸ”</span> è¯†åˆ«
                    </button>
                </div>
            </section>

            <!-- ç»“æœåŒºåŸŸ -->
            <section class="result-section">
                <h2>ğŸ“Š è¯†åˆ«ç»“æœ</h2>
                <div class="result-card" id="resultCard">
                    <div class="result-digit" id="resultDigit">?</div>
                    <div class="result-confidence" id="resultConfidence">
                        ç­‰å¾…è¯†åˆ«...
                    </div>
                </div>

                <!-- å„æ•°å­—è¯¦æƒ… -->
                <div class="details-section" id="detailsSection" style="display: none;">
                    <h3>è¯†åˆ«è¯¦æƒ…</h3>
                    <div class="details-list" id="detailsList">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </section>
        </main>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>ä½¿ç”¨ PyTorch + Flask æ„å»º | CNN æ¨¡å‹è¯†åˆ« MNIST æ‰‹å†™æ•°å­—</p>
        </footer>
    </div>

    <script>
        // ç”»å¸ƒè®¾ç½®
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('canvasOverlay');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let hasDrawn = false;

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 15;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        initCanvas();

        // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶
        function getPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPosition(e);
            lastX = pos.x;
            lastY = pos.y;

            if (!hasDrawn) {
                hasDrawn = true;
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 300);
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const pos = getPosition(e);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();

            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // ç»‘å®šäº‹ä»¶
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        // æ¸…é™¤æŒ‰é’®
        document.getElementById('clearBtn').addEventListener('click', () => {
            initCanvas();
            hasDrawn = false;
            overlay.style.display = 'flex';
            overlay.style.opacity = '1';

            document.getElementById('resultDigit').textContent = '?';
            document.getElementById('resultConfidence').textContent = 'ç­‰å¾…è¯†åˆ«...';
            document.getElementById('resultCard').classList.remove('success');
            document.getElementById('detailsSection').style.display = 'none';
            document.getElementById('detailsList').innerHTML = '';
        });

        // è¯†åˆ«æŒ‰é’®
        document.getElementById('predictBtn').addEventListener('click', async () => {
            if (!hasDrawn) {
                alert('è¯·å…ˆåœ¨ç”»å¸ƒä¸Šä¹¦å†™æ•°å­—ï¼');
                return;
            }

            const btn = document.getElementById('predictBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> è¯†åˆ«ä¸­...';

            try {
                const imageData = canvas.toDataURL('image/png');

                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const result = await response.json();

                if (result.success) {
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('resultDigit').textContent = result.result;
                    document.getElementById('resultConfidence').textContent =
                        `å¹³å‡ç½®ä¿¡åº¦: ${result.confidence}% | è¯†åˆ« ${result.count} ä¸ªæ•°å­—`;
                    document.getElementById('resultCard').classList.add('success');

                    // æ˜¾ç¤ºå„æ•°å­—è¯¦æƒ…
                    if (result.details && result.details.length > 0) {
                        const detailsSection = document.getElementById('detailsSection');
                        const detailsList = document.getElementById('detailsList');
                        detailsList.innerHTML = '';

                        result.details.forEach((d, i) => {
                            const item = document.createElement('div');
                            item.className = 'detail-item';
                            item.innerHTML = `
                                <span class="detail-digit">${d.digit}</span>
                                <span class="detail-confidence">${d.confidence}%</span>
                            `;
                            detailsList.appendChild(item);
                        });

                        detailsSection.style.display = 'block';
                    }
                } else {
                    alert('è¯†åˆ«å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ”</span> è¯†åˆ«';
            }
        });
    </script>
</body>

</html>